<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Daily Journal</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; width: 100%; overflow: hidden; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0f0f1a;
      color: #fff;
    }

    .screen {
      position: fixed;
      inset: 0;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px 20px;
    }

    /* SETUP SCREEN */
    #setupScreen {
      background: radial-gradient(ellipse at 50% 40%, #1e1e3a 0%, #0f0f1a 70%);
      justify-content: flex-start;
      padding-top: 60px;
      overflow-y: auto;
    }
    .setup-title {
      font-size: clamp(28px, 8vw, 44px);
      font-weight: 700;
      margin-bottom: 10px;
      text-align: center;
    }
    .setup-subtitle {
      font-size: clamp(15px, 4vw, 20px);
      color: rgba(255,255,255,0.4);
      text-align: center;
      line-height: 1.6;
      margin-bottom: 40px;
      max-width: 500px;
    }
    .setup-form {
      width: 100%;
      max-width: 560px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding-bottom: 40px;
    }
    .field-label {
      font-size: clamp(14px, 3.5vw, 17px);
      color: rgba(255,255,255,0.6);
      margin-bottom: 8px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }
    .field-hint {
      font-size: clamp(12px, 3vw, 14px);
      color: rgba(255,255,255,0.3);
      margin-bottom: 10px;
      line-height: 1.5;
    }
    .field-input {
      width: 100%;
      padding: clamp(16px, 4vw, 20px);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.06);
      color: #fff;
      font-size: clamp(14px, 3.5vw, 17px);
      outline: none;
      transition: border-color 0.2s;
      font-family: inherit;
    }
    .field-input:focus { border-color: rgba(102,126,234,0.7); }
    .field-input::placeholder { color: rgba(255,255,255,0.2); }
    .setup-btn {
      width: 100%;
      padding: clamp(20px, 5.5vw, 26px);
      border-radius: 20px;
      border: none;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      font-size: clamp(20px, 5.5vw, 26px);
      font-weight: 700;
      cursor: pointer;
      margin-top: 8px;
      transition: opacity 0.2s, transform 0.15s;
    }
    .setup-btn:active { transform: scale(0.98); opacity: 0.9; }
    .setup-note {
      font-size: clamp(12px, 3vw, 14px);
      color: rgba(255,255,255,0.25);
      text-align: center;
      line-height: 1.6;
      margin-top: 4px;
    }

    /* IDLE */
    #idleScreen { background: radial-gradient(ellipse at 50% 40%, #1e1e3a 0%, #0f0f1a 70%); }
    .journal-title { font-size: clamp(36px, 11vw, 64px); font-weight: 700; margin-bottom: 10px; }
    .journal-date { font-size: clamp(18px, 5vw, 26px); color: rgba(255,255,255,0.4); margin-bottom: 52px; }
    .mic-ring {
      position: relative;
      width: clamp(200px, 52vw, 280px);
      height: clamp(200px, 52vw, 280px);
      margin-bottom: 52px;
    }
    .mic-ring::before {
      content: '';
      position: absolute;
      inset: -10px;
      border-radius: 50%;
      background: conic-gradient(#667eea, #764ba2, #f093fb, #667eea);
      animation: spin 4s linear infinite;
      opacity: 0.7;
    }
    .mic-ring::after {
      content: '';
      position: absolute;
      inset: -5px;
      border-radius: 50%;
      background: #0f0f1a;
    }
    .mic-btn {
      position: absolute;
      inset: 0;
      z-index: 1;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      font-size: clamp(60px, 16vw, 100px);
      cursor: pointer;
      width: 100%;
      height: 100%;
      transition: transform 0.15s ease;
    }
    .mic-btn:active { transform: scale(0.94); }
    .idle-hint { font-size: clamp(20px, 5.5vw, 28px); color: rgba(255,255,255,0.4); text-align: center; line-height: 1.6; }
    .settings-link {
      position: fixed;
      bottom: 28px;
      right: 24px;
      font-size: clamp(12px, 3vw, 14px);
      color: rgba(255,255,255,0.2);
      cursor: pointer;
      text-decoration: none;
      transition: color 0.2s;
    }
    .settings-link:hover { color: rgba(255,255,255,0.5); }

    /* RECORDING */
    #recordingScreen { background: radial-gradient(ellipse at 50% 40%, #2a0a1a 0%, #0f0f1a 70%); }
    .rec-indicator { display: flex; align-items: center; gap: 12px; margin-bottom: 36px; }
    .rec-dot { width: 18px; height: 18px; border-radius: 50%; background: #f5576c; animation: blink 1s infinite; }
    .rec-label { font-size: clamp(18px, 5vw, 26px); color: #f5576c; font-weight: 600; letter-spacing: 3px; text-transform: uppercase; }
    .timer-display { font-size: clamp(80px, 22vw, 150px); font-weight: 700; letter-spacing: -3px; line-height: 1; margin-bottom: 28px; font-variant-numeric: tabular-nums; }
    .live-transcript {
      width: 100%; max-width: 640px; overflow-y: auto;
      font-size: clamp(20px, 5.5vw, 28px); line-height: 1.6;
      color: rgba(255,255,255,0.7); text-align: center;
      padding: 0 8px; margin-bottom: 36px; max-height: 28vh;
    }
    .live-transcript .interim { color: rgba(255,255,255,0.3); }
    .stop-btn {
      width: clamp(150px, 42vw, 210px); height: clamp(150px, 42vw, 210px);
      border-radius: 50%; border: 3px solid rgba(245,87,108,0.5);
      background: rgba(245,87,108,0.15); color: #f5576c;
      font-size: clamp(52px, 14vw, 80px); cursor: pointer;
      transition: all 0.2s ease; animation: pulse-red 2s infinite;
    }
    .stop-btn:active { transform: scale(0.94); background: rgba(245,87,108,0.3); }

    /* REVIEW */
    #reviewScreen {
      background: radial-gradient(ellipse at 50% 40%, #0a1a2a 0%, #0f0f1a 70%);
      justify-content: flex-start; padding-top: 60px; overflow-y: auto;
    }
    .review-title { font-size: clamp(28px, 8vw, 48px); font-weight: 700; margin-bottom: 8px; }
    .review-subtitle { font-size: clamp(16px, 4.5vw, 22px); color: rgba(255,255,255,0.4); margin-bottom: 32px; text-align: center; }
    .transcript-preview {
      width: 100%; max-width: 640px;
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 24px; padding: 28px;
      font-size: clamp(18px, 5vw, 24px); line-height: 1.7;
      color: rgba(255,255,255,0.8); margin-bottom: 32px;
      max-height: 36vh; overflow-y: auto;
    }
    .review-actions { width: 100%; max-width: 640px; display: flex; flex-direction: column; gap: 16px; padding-bottom: 40px; }
    .save-btn {
      width: 100%; padding: clamp(22px, 6vw, 30px); border-radius: 20px; border: none;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white; font-size: clamp(22px, 6vw, 30px); font-weight: 700;
      cursor: pointer; transition: opacity 0.2s, transform 0.15s;
    }
    .save-btn:active { transform: scale(0.98); opacity: 0.9; }
    .save-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
    .retry-btn {
      width: 100%; padding: clamp(18px, 5vw, 24px); border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.15); background: transparent;
      color: rgba(255,255,255,0.5); font-size: clamp(18px, 5vw, 24px);
      cursor: pointer; transition: all 0.2s;
    }
    .retry-btn:active { background: rgba(255,255,255,0.05); }

    /* PROCESSING */
    #processingScreen { background: radial-gradient(ellipse at 50% 40%, #0d1a2e 0%, #0f0f1a 70%); gap: 36px; }
    .spinner {
      width: clamp(72px, 20vw, 110px); height: clamp(72px, 20vw, 110px);
      border-radius: 50%; border: 5px solid rgba(102,126,234,0.2);
      border-top-color: #667eea; animation: spin 0.8s linear infinite;
    }
    .processing-label { font-size: clamp(24px, 7vw, 36px); font-weight: 600; color: rgba(255,255,255,0.8); text-align: center; }
    .processing-sub { font-size: clamp(16px, 4.5vw, 22px); color: rgba(255,255,255,0.35); text-align: center; }

    /* SUCCESS */
    #successScreen { background: radial-gradient(ellipse at 50% 40%, #0a2a1a 0%, #0f0f1a 70%); gap: 28px; }
    .success-icon { font-size: clamp(80px, 22vw, 120px); line-height: 1; }
    .success-title { font-size: clamp(36px, 10vw, 60px); font-weight: 700; color: #6ee7b7; }
    .success-sub { font-size: clamp(18px, 5vw, 26px); color: rgba(255,255,255,0.45); text-align: center; line-height: 1.6; }
    .done-btn {
      margin-top: 8px; padding: clamp(20px, 5vw, 26px) clamp(40px, 10vw, 64px);
      border-radius: 20px; border: 1px solid rgba(110,231,183,0.3);
      background: rgba(110,231,183,0.1); color: #6ee7b7;
      font-size: clamp(20px, 5.5vw, 28px); font-weight: 600; cursor: pointer;
    }
    .done-btn:active { background: rgba(110,231,183,0.2); }

    /* ERROR */
    .error-bar {
      position: fixed; bottom: 32px; left: 20px; right: 20px;
      background: rgba(245,87,108,0.15); border: 1px solid rgba(245,87,108,0.4);
      border-radius: 16px; padding: 18px 22px;
      font-size: clamp(16px, 4.5vw, 20px); color: #fca5a5;
      text-align: center; display: none; z-index: 100;
    }

    /* ANIMATIONS */
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
    @keyframes pulse-red {
      0%, 100% { box-shadow: 0 0 0 0 rgba(245,87,108,0.4); }
      50%       { box-shadow: 0 0 0 24px rgba(245,87,108,0); }
    }
  </style>
</head>
<body>

  <!-- SETUP -->
  <div class="screen" id="setupScreen">
    <div class="setup-title">üìì Welcome</div>
    <div class="setup-subtitle">Enter your credentials once to get started.<br>They are saved privately on this device only.</div>
    <div class="setup-form">
      <div>
        <div class="field-label">Apps Script URL</div>
        <div class="field-hint">Your Google Apps Script deployment URL ‚Äî starts with https://script.google.com/...</div>
        <input class="field-input" id="urlInput" type="url" placeholder="https://script.google.com/macros/s/..." />
      </div>
      <div>
        <div class="field-label">Secret Token</div>
        <div class="field-hint">The secret token you set in your Apps Script Code.gs file</div>
        <input class="field-input" id="tokenInput" type="password" placeholder="Your secret token" />
      </div>
      <button class="setup-btn" onclick="saveSetup()">Save & Get Started</button>
      <div class="setup-note">These values are stored locally on your device and never sent anywhere except your own Apps Script endpoint.</div>
    </div>
  </div>

  <!-- IDLE -->
  <div class="screen" id="idleScreen">
    <div class="journal-title">üìì Daily Journal</div>
    <div class="journal-date" id="todayDate"></div>
    <div class="mic-ring">
      <button class="mic-btn" onclick="startRecording()">üéôÔ∏è</button>
    </div>
    <div class="idle-hint">Tap the mic and talk<br>about your day</div>
    <span class="settings-link" onclick="openSetup()">‚öôÔ∏è settings</span>
  </div>

  <!-- RECORDING -->
  <div class="screen" id="recordingScreen">
    <div class="rec-indicator">
      <div class="rec-dot"></div>
      <div class="rec-label">Recording</div>
    </div>
    <div class="timer-display" id="timerDisplay">00:00</div>
    <div class="live-transcript" id="liveTranscript">
      <span class="interim">Listening...</span>
    </div>
    <button class="stop-btn" onclick="stopRecording()">‚èπÔ∏è</button>
  </div>

  <!-- REVIEW -->
  <div class="screen" id="reviewScreen">
    <div class="review-title">Review Your Entry</div>
    <div class="review-subtitle">Looks good? Save it and let Gemini do the rest.</div>
    <div class="transcript-preview" id="transcriptPreview"></div>
    <div class="review-actions">
      <button class="save-btn" id="saveBtn" onclick="submitJournal()">‚ú® Synthesize & Save</button>
      <button class="retry-btn" onclick="resetToIdle()">Start Over</button>
    </div>
  </div>

  <!-- PROCESSING -->
  <div class="screen" id="processingScreen">
    <div class="spinner"></div>
    <div class="processing-label">Synthesizing your day...</div>
    <div class="processing-sub">Gemini is reading between the lines</div>
  </div>

  <!-- SUCCESS -->
  <div class="screen" id="successScreen">
    <div class="success-icon">‚úÖ</div>
    <div class="success-title">Entry Saved</div>
    <div class="success-sub">Your day has been logged<br>and structured automatically</div>
    <button class="done-btn" onclick="resetToIdle()">Done</button>
  </div>

  <!-- ERROR -->
  <div class="error-bar" id="errorBar"></div>

  <script>
    let recognition;
    let isRecording = false;
    let transcript  = '';
    let timerInterval;
    let seconds     = 0;
    let wakeLock    = null;

    // Load credentials from localStorage
    let APPS_SCRIPT_URL = localStorage.getItem('journal_url')   || '';
    let SECRET_TOKEN    = localStorage.getItem('journal_token') || '';

    document.getElementById('todayDate').textContent =
      new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

    function init() {
      if (!APPS_SCRIPT_URL || !SECRET_TOKEN) {
        showScreen('setupScreen');
      } else {
        showScreen('idleScreen');
      }
    }

    function saveSetup() {
      const url   = document.getElementById('urlInput').value.trim();
      const token = document.getElementById('tokenInput').value.trim();
      if (!url || !token) {
        showError('Please fill in both fields before continuing.');
        return;
      }
      localStorage.setItem('journal_url',   url);
      localStorage.setItem('journal_token', token);
      APPS_SCRIPT_URL = url;
      SECRET_TOKEN    = token;
      showScreen('idleScreen');
    }

    function openSetup() {
      document.getElementById('urlInput').value   = APPS_SCRIPT_URL;
      document.getElementById('tokenInput').value = SECRET_TOKEN;
      showScreen('setupScreen');
    }

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
      document.getElementById(id).style.display = 'flex';
    }

    async function requestWakeLock() {
      try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
    }
    async function releaseWakeLock() {
      if (wakeLock) { await wakeLock.release(); wakeLock = null; }
    }
    document.addEventListener('visibilitychange', async () => {
      if (document.visibilityState === 'visible' && isRecording) await requestWakeLock();
    });

    async function startRecording() {
      hideError();
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        stream.getTracks().forEach(t => t.stop());
      } catch(err) {
        showError(err.name === 'NotAllowedError'
          ? 'Microphone access denied. Check your browser settings and try again.'
          : 'Could not access microphone: ' + err.message);
        return;
      }

      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showError('Speech recognition not supported. Use Chrome on Android or Safari on iPhone.');
        return;
      }

      await requestWakeLock();
      transcript = '';
      showScreen('recordingScreen');
      document.getElementById('liveTranscript').innerHTML = '<span class="interim">Listening...</span>';

      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SR();
      recognition.continuous     = true;
      recognition.interimResults = true;
      recognition.lang           = 'en-US';

      recognition.onresult = (e) => {
        let final = '', interim = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          if (e.results[i].isFinal) final  += e.results[i][0].transcript + ' ';
          else                       interim += e.results[i][0].transcript;
        }
        transcript += final;
        document.getElementById('liveTranscript').innerHTML =
          transcript + (interim ? '<span class="interim">' + interim + '</span>' : '');
      };

      recognition.onerror = (e) => {
        if (e.error !== 'no-speech') { showError('Microphone error: ' + e.error); stopRecording(); }
      };
      recognition.onend = () => { if (isRecording) recognition.start(); };
      recognition.start();
      isRecording = true;

      seconds = 0;
      timerInterval = setInterval(() => {
        seconds++;
        document.getElementById('timerDisplay').textContent =
          String(Math.floor(seconds / 60)).padStart(2, '0') + ':' +
          String(seconds % 60).padStart(2, '0');
      }, 1000);
    }

    async function stopRecording() {
      if (recognition) recognition.stop();
      isRecording = false;
      clearInterval(timerInterval);
      await releaseWakeLock();
      if (transcript.trim().length > 0) {
        document.getElementById('transcriptPreview').textContent = transcript.trim();
        showScreen('reviewScreen');
      } else {
        showError('Nothing was recorded. Tap the mic and try again.');
        showScreen('idleScreen');
      }
    }

    async function submitJournal() {
      if (!transcript.trim()) return;
      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = true;
      showScreen('processingScreen');

      try {
        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ transcript: transcript, token: SECRET_TOKEN })
        });
        const result = await response.json();
        if (result.status === 'success') {
          showScreen('successScreen');
        } else {
          throw new Error(result.message || 'Unknown error');
        }
      } catch(err) {
        showScreen('reviewScreen');
        showError('Something went wrong: ' + err.message);
      } finally {
        saveBtn.disabled = false;
      }
    }

    function resetToIdle() {
      transcript = '';
      seconds    = 0;
      document.getElementById('timerDisplay').textContent = '00:00';
      document.getElementById('liveTranscript').innerHTML = '<span class="interim">Listening...</span>';
      hideError();
      showScreen('idleScreen');
    }

    function showError(msg) {
      const bar = document.getElementById('errorBar');
      bar.textContent   = msg;
      bar.style.display = 'block';
      setTimeout(hideError, 6000);
    }
    function hideError() {
      document.getElementById('errorBar').style.display = 'none';
    }

    init();
  </script>
</body>
</html>
